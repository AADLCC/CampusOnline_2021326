<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
      xmlns:h="http://xmlns.jcp.org/jsf/html"
      xmlns:p="http://primefaces.org/ui"
      xmlns:f="http://xmlns.jcp.org/jsf/core">
<h:head>
    <title>Gestión de Calificaciones</title>
    <!-- PrimeFlex ya está incluido, lo usaremos en el modal -->
    <link rel="stylesheet" href="https://unpkg.com/primeflex@latest/primeflex.css"/>
</h:head>
<h:body>
    <h:form id="formCalificaciones">
        <!-- ... (La parte del menubar y la tabla se quedan igual) ... -->
        <p:growl id="mensajes" showDetail="true" showSummary="true" life="4000"/>

        <p:menubar>
            <p:menuitem value="Nueva Calificación" icon="pi pi-plus"
                        actionListener="#{calificacionController.prepararNuevaCalificacion}"
                        update=":formModal:dialogoContenido"
                        oncomplete="PF('dialogoCalificacion').show();"
                        process="@this"/>
        </p:menubar>

        <p:dataTable id="tablaCalificaciones" value="#{calificacionController.calificaciones}" var="cali"
                     paginator="true" rows="10" responsiveLayout="scroll" styleClass="p-datatable-gridlines">
            <f:facet name="header">
                <h3>Listado de Calificaciones</h3>
            </f:facet>
            <p:column headerText="Alumno" sortBy="#{cali.idAlumno()}">
                <h:outputText value="#{cali.idAlumno()}"/> <!-- Aquí podrías mostrar el nombre si lo tuvieras en el DTO -->
            </p:column>
            <p:column headerText="Curso" sortBy="#{cali.idCurso()}">
                <h:outputText value="#{cali.idCurso()}"/> <!-- Igual aquí -->
            </p:column>
            <p:column headerText="Puntuación" sortBy="#{cali.puntuacion()}">
                <h:outputText value="#{cali.puntuacion()}"/>
            </p:column>
            <p:column headerText="Fecha" sortBy="#{cali.fechaCalificacion()}">
                <h:outputText value="#{cali.fechaCalificacion()}">
                    <f:convertDateTime type="localDateTime" pattern="yyyy-MM-dd HH:mm"/>
                </h:outputText>
            </p:column>
            <p:column headerText="Acciones" style="text-align:center;">
                <p:commandButton icon="pi pi-pencil"
                                 update=":formModal:dialogoContenido"
                                 oncomplete="PF('dialogoCalificacion').show()"
                                 actionListener="#{calificacionController.seleccionarCalificacion(cali)}"
                                 styleClass="ui-button-primary"
                                 title="Editar"/>
                <p:commandButton icon="pi pi-trash"
                                 actionListener="#{calificacionController.eliminarCalificacion(cali.idAlumno(), cali.idCurso())}"
                                 update=":formCalificaciones:tablaCalificaciones :formCalificaciones:mensajes"
                                 styleClass="ui-button-danger"
                                 title="Eliminar">
                    <p:confirm header="Confirmación" message="¿Estás seguro de que deseas eliminar esta calificación?" icon="pi pi-exclamation-triangle"/>
                </p:commandButton>
            </p:column>
        </p:dataTable>

        <p:confirmDialog global="true" showEffect="fade" hideEffect="fade" responsive="true" width="350">
            <p:commandButton value="No" type="button" styleClass="ui-confirmdialog-no ui-button-secondary"/>
            <p:commandButton value="Sí" type="button" styleClass="ui-confirmdialog-yes"/>
        </p:confirmDialog>

    </h:form>

    <h:form id="formModal">
        <p:dialog header="Detalles de Calificación" widgetVar="dialogoCalificacion" modal="true" responsive="true" width="500">

            <!-- CAMBIO: Usamos PrimeFlex para un layout más limpio y moderno -->
            <p:outputPanel id="dialogoContenido" styleClass="p-fluid">
                <div class="field">
                    <p:outputLabel for="alumno" value="Alumno"/>
                    <!-- CAMBIO: inputText a selectOneMenu (ComboBox) -->
                    <p:selectOneMenu id="alumno" value="#{calificacionController.idAlumnoForm}" required="true"
                                     filter="true" filterMatchMode="contains">
                        <f:selectItem itemLabel="Seleccione un Alumno" itemValue="#{null}" noSelectionOption="true"/>
                        <f:selectItems value="#{calificacionController.listaAlumnos}" var="a"
                                       itemLabel="#{a.nombre()} #{a.apellido()}" itemValue="#{a.idAlumno()}"/>
                    </p:selectOneMenu>
                </div>

                <div class="field">
                    <p:outputLabel for="curso" value="Curso"/>
                    <!-- CAMBIO: inputText a selectOneMenu (ComboBox) -->
                    <p:selectOneMenu id="curso" value="#{calificacionController.idCursoForm}" required="true"
                                     filter="true" filterMatchMode="contains">
                        <f:selectItem itemLabel="Seleccione un Curso" itemValue="#{null}" noSelectionOption="true"/>
                        <f:selectItems value="#{calificacionController.listaCursos}" var="c"
                                       itemLabel="#{c.nombreCurso()}" itemValue="#{c.idCurso()}"/>
                    </p:selectOneMenu>
                </div>

                <div class="field">
                    <p:outputLabel for="puntuacion" value="Puntuación"/>
                    <p:inputNumber id="puntuacion" value="#{calificacionController.puntuacionForm}" minValue="0" maxValue="100"
                                   required="true" showButtons="true" decimalPlaces="2"/>
                </div>
            </p:outputPanel>

            <f:facet name="footer">
                <p:commandButton value="Guardar" icon="pi pi-check"
                                 actionListener="#{calificacionController.guardarCalificacion}"
                                 update=":formCalificaciones:tablaCalificaciones :formCalificaciones:mensajes"
                                 process="dialogoContenido @this"  oncomplete="if (!args.validationFailed) PF('dialogoCalificacion').hide();"/>
                <p:commandButton value="Cancelar" icon="pi pi-times" styleClass="ui-button-secondary"
                                 onclick="PF('dialogoCalificacion').hide()" type="button"/>
            </f:facet>
        </p:dialog>
    </h:form>
</h:body>
</html>